<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Modulador de voz</title>
  <style>
    :root{
      --bg:#0b0f14;            
      --panel:#0f172a;          
      --panel-2:#111827;        
      --text:#e5e7eb;           
      --muted:#94a3b8;          
      --border:rgba(255,255,255,.08);
      --accent:#3b82f6;         
      --accent-2:#0ea5e9;       
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --focus:0 0 0 3px rgba(59,130,246,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(14,165,233,.10), transparent 60%),
        radial-gradient(1000px 600px at -10% 110%, rgba(59,130,246,.10), transparent 60%),
        var(--bg);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    .shell{
      max-width: 980px;
      margin: 40px auto 80px;
      padding: 0 20px;
    }

    .header{
      display:flex; align-items:center; gap:14px; margin-bottom:22px;
    }
    .logo{
      width:42px;height:42px;border-radius:12px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      box-shadow: var(--shadow);
    }
    .title{
      margin:0;
      font-weight:700;
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted); margin:4px 0 0;
      font-size:.95rem;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding: 22px;
    }

    .section-title{
      margin:0 0 8px; font-size:.95rem; color:var(--muted); font-weight:600; letter-spacing:.3px;
      text-transform:uppercase;
    }

    label{display:block; margin:10px 0 6px; font-weight:600; color:var(--text)}
    .hint{color:var(--muted); font-size:.85rem; margin-top:4px}

    textarea,input,select,button{
      width:100%; border-radius:12px; border:1px solid var(--border); background:var(--panel-2);
      color:var(--text); padding:12px 14px; transition:.2s border-color, .2s box-shadow, .2s transform;
    }
    textarea{min-height:140px; resize:vertical}
    input::placeholder, textarea::placeholder{color:#7a8aa0}
    input:focus, textarea:focus, select:focus{outline:none; box-shadow:var(--focus); border-color:rgba(59,130,246,.55)}

    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:14px}
    @media (max-width:780px){ .grid-2, .grid-3{grid-template-columns:1fr} }

    .inline{
      display:flex; align-items:center; flex-wrap:wrap; gap:10px; margin-top:10px;
      background:rgba(255,255,255,.02); border:1px solid var(--border); padding:10px 12px; border-radius:12px;
    }
    .inline input[type="checkbox"]{width:auto; height:auto; accent-color:var(--accent)}

    .actions{display:flex; align-items:center; gap:12px; margin-top:16px}

    button{
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      border:none; font-weight:700; letter-spacing:.2px; cursor:pointer;
      box-shadow:0 10px 25px rgba(14,165,233,.25);
      transform:translateY(0);
    }
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    button:disabled{
      opacity:.6; cursor:not-allowed; filter:grayscale(.2); box-shadow:none;
    }

    .player{
      margin-top:16px; width:100%; background:var(--panel-2); border:1px solid var(--border); border-radius:12px;
    }

    /* chips */
    .chip{
      display:inline-flex; align-items:center; gap:8px; padding:10px 12px;
      background:rgba(59,130,246,.12); border:1px solid rgba(59,130,246,.25);
      color:#cfe2ff; border-radius:999px; font-size:.88rem; font-weight:600;
    }
    .chip::before{
      content:""; width:8px; height:8px; border-radius:999px; background:var(--accent);
      box-shadow:0 0 0 3px rgba(59,130,246,.25);
    }

    .footer{
      margin-top:14px; color:var(--muted); font-size:.85rem; text-align:center;
    }
  </style>
</head>

<body>
  <div class="shell">
    <header class="header">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1 class="title">Modulador de Voz</h1>
        <p class="subtitle">Escribe y personaliza la voz.</p>
      </div>
    </header>

    <div class="card">
      <label for="text">Texto</label>
      <textarea id="text" placeholder="Escribe aquí..."></textarea>

      <h3 class="section-title">Parámetros</h3>
      <div class="grid-2">
        <div>
          <label for="voice">Voz</label>
          <select id="voice">
            {% for v in voices %}
            <option value="{{ v }}">{{ v }}</option>
            {% endfor %}
          </select>
          <div class="hint"></div>
        </div>
        <div>
          <label for="style">Estilo</label>
          <select id="style">
            {% for s in styles %}
            <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
          </select>
          <div class="hint"></div>
        </div>
      </div>

      <div class="grid-3" style="margin-top:10px">
        <div>
          <label for="styledegree">Intensidad (styledegree)</label>
          <input id="styledegree" type="number" step="0.1" min="0.1" max="2" value="1.2"/>
          <div class="hint"></div>
        </div>
        <div>
          <label for="rate">Ritmo (rate)</label>
          <input id="rate" type="text" value="+0%" placeholder="+5% / -5%"/>
          <div class="hint"></div>
        </div>
        <div>
          <label for="pitch">Tono (pitch)</label>
          <input id="pitch" type="text" value="+0st" placeholder="+1st / -1st"/>
          <div class="hint">

          </div>
        </div>
      </div>

      <div class="inline">
        <input id="use_sentence_silence" type="checkbox" checked/>
        <label for="use_sentence_silence" style="margin:0">Pausas automáticas entre oraciones</label>
        <input id="pause_ms" type="text" value="200ms" style="width: 120px;" title="ej. 200ms"/>
      </div>

      <div class="actions">
        <button id="speak">Hablar</button>
      </div>

      <audio id="player" class="player" controls></audio>

    </div>
  </div>

<script>
const speakBtn = document.getElementById('speak');
const player   = document.getElementById('player');

speakBtn.onclick = async () => {
  const payload = {
    text: document.getElementById('text').value,
    voice: document.getElementById('voice').value,
    style: document.getElementById('style').value,
    styledegree: parseFloat(document.getElementById('styledegree').value || "1.2"),
    rate: document.getElementById('rate').value || "+0%",
    pitch: document.getElementById('pitch').value || "+0st",
    use_sentence_silence: document.getElementById('use_sentence_silence').checked,
    pause_ms: document.getElementById('pause_ms').value || "200ms"
  };

  console.log("[UI] Payload:", payload);
  speakBtn.disabled = true; speakBtn.textContent = "Sintetizando...";

  try {
    const res = await fetch("/api/tts/", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
    console.log("[UI] /api/tts/ status:", res.status, res.statusText, res.headers.get("content-type"));

    if (!res.ok) {
      const txt = await res.text();
      console.error("[UI] Error body:", txt);
      alert("Error " + res.status + ": " + txt);
      return;
    }

    const blob = await res.blob();
    console.log("[UI] Blob size:", blob.size, "type:", blob.type);
    if (!blob.size) {
      alert("Se recibió audio vacío.");
      return;
    }

    const url = URL.createObjectURL(blob);
    player.src = url;
    player.load();
    try {
      await player.play();              
      console.log("[UI] Reproduciendo OK");
    } catch (e) {
      console.warn("[UI] No se pudo reproducir automáticamente:", e);
      const a = document.createElement("a");
      a.href = url; a.download = "voz.mp3"; a.click();
      alert("No se pudo reproducir automáticamente. Se descargó el audio para verificar.");
    }
  } catch (e) {
    console.error("[UI] Excepción:", e);
    alert("Excepción en fetch: " + e.message);
  } finally {
    speakBtn.disabled = false; speakBtn.textContent = "Hablar";
  }
};
</script>


</body>
</html>
